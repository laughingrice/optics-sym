#!/usr/bin/env bash
# Pre-commit hook: warn when generated files (icons, www, appiconset) are staged
set -e
STAGED=$(git diff --cached --name-only)
if [ -z "$STAGED" ]; then exit 0; fi
# patterns to warn about
warn_patterns=("^assets/appicons/" "^www/" "^ios/App/App/Assets.xcassets/AppIcon.appiconset/" )
warn_files=()
while read -r f; do
  for p in "${warn_patterns[@]}"; do
    if [[ "$f" =~ $p ]]; then warn_files+=("$f"); fi
  done
done <<< "$STAGED"
if [ ${#warn_files[@]} -gt 0 ]; then
  echo "\n⚠️  Error: Generated files staged for commit:";
  for wf in "${warn_files[@]}"; do echo "  - $wf"; done
  echo "\nIt's recommended to keep generated files out of git. To unstage these files: git reset HEAD -- <file>\n";
  # Allow override in exceptional cases by setting ALLOW_GENERATED=1 in the environment
  if [ "${ALLOW_GENERATED}" = "1" ]; then
    echo "ALLOW_GENERATED=1 detected — allowing commit despite generated files.";
    exit 0;
  fi
  echo "Commit blocked. To bypass, run 'git commit --no-verify' or set ALLOW_GENERATED=1 for this invocation.";
  exit 1;
fi
exit 0
